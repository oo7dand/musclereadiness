<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="./favicon.png">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1120">
<title>Muscle Cooldown (v7.2 PWA)</title>
<style>
:root{
  --bg:#0b1120; --card:#0e1628; --text:#e8ecf3; --muted:#9aa6b2;
  --border:#1c2740; --red:#ef4444; --yellow:#f59e0b; --green:#10b981; --stale:#064e3b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
header,footer{padding:12px 16px;background:#0a1020;border-bottom:1px solid var(--border)}
footer{border-top:1px solid var(--border);border-bottom:none;text-align:center}
main{max-width:1100px;margin:0 auto;padding:16px}
h1{margin:0;font-size:20px;font-weight:600}
h2{margin:.2rem 0 .6rem;font-size:18px}
h3{margin:.15rem 0 .35rem;font-size:16px}
nav{display:flex;gap:8px;padding:8px 16px;background:#0a1020;position:sticky;top:48px;z-index:5}
.tab{background:#0f182e;color:var(--muted);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;transition:transform .06s ease}
.tab:hover{transform:translateY(-1px)}
.tab.active{color:#fff;border-color:#334155;background:#111c32}
.panel{display:none;padding-top:10px}
.panel.active{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 0 0 1px rgba(0,0,0,.05) inset;transition:transform .06s ease, box-shadow .1s ease}
.card:hover{transform:translateY(-1px); box-shadow:0 4px 20px rgba(0,0,0,.2)}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px}
.red{background:var(--red);color:#fff}.yellow{background:#f2c14e;color:#1b1b1b}.green{background:var(--green);color:#0b2b1f}.stale{background:var(--stale);color:#e8fff6}
.dot{font-size:14px;line-height:1}
.btn{border:1px solid #2a3a55;background:#182840;color:#e5e7eb;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px;transition:transform .06s ease}
.btn:hover{transform:translateY(-1px)}
.btn.ghost{background:transparent;border-color:var(--border)}
.btn.small{padding:8px 10px;font-size:13px;border-radius:9px}
.btn.lg{padding:12px 14px;font-size:16px;border-radius:12px}
.btn[disabled]{opacity:.45;cursor:not-allowed;transform:none}
.row{display:grid;grid-template-columns:260px 1fr;gap:10px;align-items:center;margin-bottom:10px}
input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
select{appearance:none}
.list{display:flex;flex-direction:column;gap:8px}
.item{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
.micon{width:28px;height:28px;flex:0 0 28px;border-radius:6px;background:#0f1a2e;display:inline-flex;align-items:center;justify-content:center;overflow:hidden}
.micon img{width:24px;height:24px;display:block}
.pillbox{display:flex;flex-direction:column;gap:6px}
.pillrow{display:grid;grid-template-columns:1fr 140px;gap:8px;align-items:center}
small.muted{color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
hr.sep{border:0;border-top:1px solid var(--border);margin:12px 0}
.meta{display:flex;gap:8px;align-items:center;margin-top:6px}
.meta small{color:var(--muted)}
.slim{display:flex;gap:8px;align-items:center;justify-content:space-between}
.slim .title{display:flex;gap:8px;align-items:center}
.subtle{color:var(--muted);font-size:12px}
#logger{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#0c1730;border:1px solid var(--border);padding:10px;border-radius:12px}
#history .card{padding:8px}
.note{color:var(--muted);font-size:12px;margin-left:8px}
@media (max-width:560px){ .row{grid-template-columns:1fr} }

/* Modal styles (for primary exercise list) */
#ex-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; }
#ex-modal.show{ display:flex; }
#ex-modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
#ex-modal .sheet{ position:relative; width:min(720px,92vw); max-height:80vh; overflow:auto;
  background:#0e1628; border:1px solid #1c2740; border-radius:14px; padding:14px; color:#e8ecf3; }
#ex-modal h3{ margin:0 0 8px 0; font-size:18px; }
#ex-modal .muted{ color:#9aa6b2; font-size:12px; margin-bottom:8px; }
#ex-modal .list{ display:flex; flex-direction:column; gap:8px; }
#ex-modal .row{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
  background:#0f182e; border:1px solid #1c2740; border-radius:10px; padding:10px; }
#ex-modal .btn{ border:1px solid #2a3a55;background:#182840;color:#e5e7eb;padding:8px 10px;border-radius:9px;cursor:pointer;font-size:13px}
#ex-modal .btn.ghost{ background:transparent }
  .app-header{display:flex;align-items:center;gap:10px}
.brand{display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
.brand-logo{height:32px;width:auto;display:block;filter:drop-shadow(0 0 6px rgba(255,0,0,.25))}
.brand-title{font-size:18px;font-weight:700;letter-spacing:.2px}
@media (max-width:560px){
  .brand-title{font-size:16px}
  .brand-logo{height:28px}
}

</style>
</head>
<body>
<header class="app-header">
  <a class="brand" href="#train" aria-label="Muscle Ready Home">
    <img src="./img/logo.png" alt="Muscle Ready" class="brand-logo">
    <span class="brand-title">Muscle Ready</span>
  </a>
</header>


<nav>
  <button class="tab active" data-tab="train" type="button">Train</button>
  <button class="tab" data-tab="muscles" type="button">Muscles</button>
  <button class="tab" data-tab="exercises" type="button">Exercises</button>
</nav>

<main>
  <section id="train" class="panel active">
    <div class="card" style="margin-bottom:10px">
      <div class="slim">
        <div>
          <h2 style="margin:0">Log workout</h2>
          <div class="subtle">Start typing to filter; list is ranked by your readiness order.</div>
        </div>
        <div id="logger">
          <input id="exerciseFilter" placeholder="Filter exercises‚Ä¶" aria-label="Filter exercises">
          <select id="logExerciseNow" title="Long‚Äëpress for form video"></select>
          <button class="btn" id="logNowBtn" type="button">Mark Done</button>
        </div>
      </div>
      <div class="note" id="rankNote"></div>
    </div>

    <div class="slim"><h2 style="margin:0">Readiness</h2><div class="subtle">Tap Clear to force ready</div></div>
    <div id="cards" class="grid"></div>

    <hr class="sep">
    <h3>History</h3>
    <div id="history" class="list"></div>
  </section>

  <section id="muscles" class="panel">
    <h2>Muscles</h2>
    <form id="mForm" class="card" onsubmit="return false;">
      <input type="hidden" id="mId">
      <div class="row"><label>Name</label><input id="mName" placeholder="e.g., Quads"></div>
      <div class="row"><label>Cooldown (hrs)</label><input id="mCd" type="number" min="1" value="48"></div>
      <div class="row"><label>Yellow window (hrs, optional)</label><input id="mYw" type="number" min="0" placeholder="Uses default if empty"></div>
      <div class="controls">
        <button class="btn" id="mSave" type="button">Save</button>
        <button class="btn ghost" id="mCancel" type="button">Cancel</button>
      </div>
    </form>
    <div id="mList" class="list" style="margin-top:10px"></div>
  </section>

  <section id="exercises" class="panel">
    <h2>Exercises</h2>
    <form id="eForm" class="card" onsubmit="return false;">
      <input type="hidden" id="eId">
      <div class="row"><label>Name</label><input id="eName" placeholder="e.g., Barbell back squat"></div>
      <div class="row"><label>Behavior</label>
        <select id="eOverride">
          <option value="inherit">Inherit global logging</option>
          <option value="adjust">Override: Adjust impacted muscles (add hours)</option>
          <option value="reset">Override: Reset impacted muscles</option>
        </select>
      </div>
      <div class="row"><label>Impacts (hours each)</label>
        <div id="eMuscles" class="pillbox"></div>
      </div>
      <div class="controls">
        <button class="btn" id="eSave" type="button">Save</button>
        <button class="btn ghost" id="eCancel" type="button">Cancel</button>
      </div>
    </form>
    <div id="eList" class="list" style="margin-top:10px"></div>
  </section>
</main>

<!-- Primary exercise modal -->
<div id="ex-modal">
  <div class="backdrop" data-close></div>
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="ex-title">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 id="ex-title">Exercises</h3>
      <button class="btn ghost" data-close type="button">Close</button>
    </div>
    <div class="muted" id="ex-sub"></div>
    <div class="list" id="ex-list"></div>
    <div class="muted" style="margin-top:6px">Hint: long‚Äëpress an exercise for a YouTube ‚Äúcorrect form‚Äù search.</div>
  </div>
</div>

<div id="error"></div>
<footer><small>v7.2 PWA ‚Äî icons & primary exercise popup + long‚Äëpress YouTube search</small></footer>

<script>
/* ---- PWA SW ---- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* ---- Utils ---- */
function showErr(msg){ const e=document.getElementById("error"); e.textContent=msg; e.style.display="block"; setTimeout(()=>{ e.style.display="none"; }, 4000); }
function clone(o){ try{return JSON.parse(JSON.stringify(o))}catch{return null} }
const KEY="mct:v7_0"; const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function el(t,a={},c=[]){ const e=document.createElement(t); for(const[k,v] of Object.entries(a)){ if(k==="class")e.className=v; else if(k==="text")e.textContent=v; else if(k.startsWith("on")) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } for(const x of c) e.appendChild(typeof x==="string"?document.createTextNode(x):x); return e; }
const h2ms=h=>Number(h||0)*3600000;
function msToDh(ms){ if(ms<=0) return "0h"; const d=Math.floor(ms/86400000); const h=Math.ceil((ms%86400000)/3600000); return (d?d+"d ":"")+h+"h"; }
function agoFromIso(iso){ if(!iso) return "never"; const diff=Date.now()-new Date(iso).getTime(); const txt=msToDh(diff); return (txt==="0h"?"<1h":txt)+" ago"; }
function remMs(m){ if(!m.lastAt) return 0; return (new Date(m.lastAt).getTime()+Number(m.cooldown||0)*3600000)-Date.now(); }
function staleCheck(m){ const ref=m.lastWorkedAt??m.lastAt; if(!ref) return true; const days=(state.settings.staleDays??10); return (Date.now()-new Date(ref).getTime()) >= days*86400000; }
function colorFor(m){ const remaining=remMs(m); if(remaining>0){ const yh=(m.yellow??state.settings.yellowDefault); if(remaining<=h2ms(yh)) return "yellow"; return "red"; } else { if(staleCheck(m)) return "stale"; return "green"; } }
function setRemainingMs(m,ms){ const cd=h2ms(m.cooldown); const lastPrime=Date.now()+ms-cd; m.lastAt=new Date(lastPrime).toISOString(); }

/* ---- Long‚Äëpress helpers + YouTube open ---- */
function openYTSearch(q){
  const url='https://www.youtube.com/results?search_query='+encodeURIComponent(q);
  window.open(url,'_blank','noopener,noreferrer');
}
function attachLongPress(el, cb, ms=550){
  let t=null, startX=0, startY=0;
  const clear=()=>{ if(t){ clearTimeout(t); t=null; } };
  const start=(e)=>{
    clear();
    const p = ('touches' in e && e.touches[0]) ? e.touches[0] : e;
    startX=p.clientX||0; startY=p.clientY||0;
    t=setTimeout(()=>{ t=null; cb(); }, ms);
  };
  const move=(e)=>{
    if(!t) return;
    const p = ('touches' in e && e.touches[0]) ? e.touches[0] : e;
    const dx=Math.abs((p.clientX||0)-startX), dy=Math.abs((p.clientY||0)-startY);
    if(dx>8||dy>8) clear();
  };
  el.addEventListener('mousedown', start);
  el.addEventListener('touchstart', start, {passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(evt=>el.addEventListener(evt, clear, {passive:true}));
  el.addEventListener('touchmove', move, {passive:true});
}

/* ---- Icons (inline, exact filenames) ---- */
const ICON_ROOT='./img/muscles';
function muscleSlug(name){
  if(name==="Chest / Pecs") return "chest";
  if(name==="Shoulders / Delts") return "shoulders";
  if(name==="Lower back") return "lowerback";
  if(name==="Upper back") return "upperback"; // add file if you use this muscle
  return name.toLowerCase().replace(/\s+\/\s+/, ' ').replace(/\s+/g,'-');
}
function iconImgByName(name){
  const i=new Image();
  i.width=24;i.height=24;i.loading='lazy';i.decoding='async';i.alt=name;
  i.src=`${ICON_ROOT}/${muscleSlug(name)}-128.png`;
  i.onerror=()=>{ i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQYV2NkYGD4DwABYQF1Q0kRngAAAABJRU5ErkJggg=="; };
  return i;
}

/* ---- Spec / Data ---- */
function buildSpec(){
  const MUSCLES = [
    ["Quads",48],["Hamstrings",48],["Glutes",48],["Lats",36],
    ["Chest / Pecs",36],["Shoulders / Delts",36],["Traps",36],
    ["Lower back",36],["Biceps",24],["Triceps",24],
    ["Abs",24],["Obliques",24],["Calves",24],["Upper back",24]
  ];
  const mObjs = MUSCLES.map(([name,cd])=>({id:uid(), name, cooldown:cd, yellow:null, lastAt:null, lastWorkedAt:null}));
  const idBy = Object.fromEntries(mObjs.map(m=>[m.name,m.id]));
  const EX = [
    ["Barbell back squat",[["Quads",48],["Glutes",24],["Hamstrings",24],["Lower back",36],["Abs",12]]],
    ["Leg press",[["Quads",36],["Glutes",24],["Hamstrings",24]]],
    ["Bulgarian split squat",[["Quads",36],["Glutes",24],["Hamstrings",24],["Abs",12]]],
    ["Conventional deadlift",[["Hamstrings",48],["Glutes",24],["Lower back",36],["Traps",36],["Abs",12]]],
    ["Romanian deadlift",[["Hamstrings",36],["Glutes",24],["Lower back",36]]],
    ["Leg curl",[["Hamstrings",24],["Calves",12]]],
    ["Barbell hip thrust",[["Glutes",36],["Hamstrings",24],["Quads",24]]],
    ["Pull-up",[["Lats",36],["Biceps",12],["Upper back",24],["Abs",12]]],
    ["Barbell row",[["Lats",36],["Upper back",24],["Shoulders / Delts",12],["Biceps",12],["Lower back",24],["Abs",12]]],
    ["Landmine 1-hand row",[["Lats",36],["Biceps",12],["Upper back",24],["Abs",12]]],
    ["Bench press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],
    ["Incline bench press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],
    ["Dumbbell press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],
    ["Seated military press",[["Shoulders / Delts",36],["Traps",36],["Triceps",12],["Chest / Pecs",24]]],
    ["Lateral raise (DB)",[["Shoulders / Delts",24],["Traps",12]]],
    ["Rear delt fly (DB/machine)",[["Shoulders / Delts",24],["Upper back",12],["Traps",12]]],
    ["Upright row",[["Shoulders / Delts",36],["Traps",24],["Biceps",12]]],
    ["Back extension",[["Lower back",36],["Glutes",24],["Hamstrings",24]]],
    ["Good mornings",[["Hamstrings",36],["Lower back",36],["Glutes",24]]],
    ["Landmine triceps press",[["Triceps",24],["Shoulders / Delts",12],["Chest / Pecs",24]]],
    ["Skull crushers",[["Triceps",24]]],
    ["Overhead triceps extension",[["Triceps",24],["Shoulders / Delts",12]]],
    ["Hanging leg raise",[["Abs",24],["Obliques",12]]],
    ["Plank",[["Abs",24],["Lower back",24],["Obliques",12],["Shoulders / Delts",12]]],
    ["Russian twist",[["Obliques",24],["Abs",12],["Lower back",24]]],
    ["Side plank",[["Obliques",24],["Abs",12],["Shoulders / Delts",12]]],
    ["Standing calf raise",[["Calves",24]]],
    ["Seated calf raise",[["Calves",24]]],
    ["Face pull (band alt)",[["Shoulders / Delts",24],["Upper back",12],["Traps",12]]],
    ["Reverse fly (DB)",[["Shoulders / Delts",24],["Traps",12],["Upper back",12]]]
  ];
  const eObjs = EX.map(([name, arr])=>({
    id:uid(), name, override:"adjust",
    impacts: arr.map(([n,h])=>({mid:idBy[n], hours:h})).filter(x=>x.mid)
  }));
  return { settings:{yellowDefault:20, staleDays:10, globalExerciseMode:"adjust"}, muscles:mObjs, exercises:eObjs, logs:[] };
}

function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) return buildSpec();
    const obj=JSON.parse(raw);
    if(!obj||!obj.muscles||!obj.exercises) return buildSpec();
    obj.muscles.forEach(m=>{ if(m.lastWorkedAt===undefined) m.lastWorkedAt=m.lastAt??null; });
    obj.exercises.forEach(e=>{ if('mode' in e) delete e.mode; });
    // Remove Forearms if present (old saves)
    obj.muscles = obj.muscles.filter(m => m.name !== 'Forearms');
    const valid = new Set(obj.muscles.map(m=>m.id));
    obj.exercises.forEach(ex => ex.impacts = (ex.impacts||[]).filter(i => valid.has(i.mid)));
    return obj;
  }catch(e){ return buildSpec(); }
}
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); } catch(e){ showErr("Save failed: "+e.message); } }
let state=load();

/* ---- Tabs ---- */
$$('.tab').forEach(b=>b.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  $$('.panel').forEach(p=>p.classList.remove('active'));
  b.classList.add('active'); const t=document.getElementById(b.dataset.tab);
  if(t) t.classList.add('active');
  renderAll();
}));

/* ---- Readiness + UI ---- */
function readinessOrder(){
  const items = state.muscles.map(m=>{
    const r=remMs(m);
    const stale=colorFor(m)==='stale';
    return {m,r,stale};
  }).sort((a,b)=>{
    if(a.stale && !b.stale) return -1;
    if(!a.stale && b.stale) return 1;
    if(a.r<=0 && b.r>0) return -1;
    if(a.r>0 && b.r<=0) return 1;
    if(a.r!==b.r) return a.r-b.r;
    return 0;
  });
  return items.map(x=>x.m.id);
}
const iconFor=st=> st==="red"?"üî¥":st==="yellow"?"üü°":st==="green"?"üü¢":"üü©";

function renderTrain(){
  makeExerciseOptions();
  const grid=document.getElementById('cards'); if(!grid) return; grid.innerHTML='';
  const order=readinessOrder();
  const items=order.map(id=>{ const m=state.muscles.find(x=>x.id===id); return {m,remaining:remMs(m)}; });
  for(const {m,remaining} of items){
    const st=colorFor(m);
    const badge=el('span',{class:'badge '+st},[
      el('span',{class:'dot',text:iconFor(st)}),
      el('span',{text: remaining>0? msToDh(remaining):'Ready'})
    ]);
    const clrDisabled=remaining<=0;
    const iconBox=el('span',{class:'micon'},[
      (function(){const i=iconImgByName(m.name); return i;})()
    ]);
    const titleWrap=el('div',{class:'title'},[iconBox, el('h3',{text:m.name})]);

    // Long‚Äëpress the muscle title to open YouTube search
    attachLongPress(titleWrap, ()=> openYTSearch('best exercises for '+m.name));

    const card=el('div',{class:'card'},[
      el('div',{class:'slim'},[ titleWrap, el('div',{},[badge]) ]),
      el('div',{class:'subtle', text:'last: '+agoFromIso(m.lastWorkedAt??m.lastAt)}),
      el('div',{style:'margin-top:8px;display:flex;gap:8px'},[
        el('button',{
          class:'btn small ghost','data-action':'clear','data-id':m.id,type:'button',
          ...(clrDisabled?{'disabled':true,'aria-disabled':'true'}:{})
        },['Clear'])
      ])
    ]);
    grid.appendChild(card);
  }
}

function exerciseRankTuple(ex, order){
  const idxs = ex.impacts.map(i=> order.indexOf(i.mid)).filter(i=>i>=0).sort((a,b)=>a-b);
  if(!idxs.length) return [9999, 9999, ex.name.toLowerCase()];
  return [idxs[0], (idxs[1]??9999), ex.name.toLowerCase()];
}

function makeExerciseOptions(){
  const note=$('#rankNote');
  const filter=($('#exerciseFilter')?.value||'').trim().toLowerCase();
  const sel=$('#logExerciseNow'); if(!sel) return; sel.innerHTML='';
  const order=readinessOrder();
  const ranked=state.exercises.map(ex=>({ex,key:exerciseRankTuple(ex,order)})).sort((a,b)=>{
    for(let i=0;i<a.key.length;i++){ if(a.key[i]!==b.key[i]) return a.key[i]-b.key[i]; } return 0;
  }).map(x=>x.ex);
  const top3 = order.slice(0,3).map(id=>state.muscles.find(m=>m.id===id)?.name).filter(Boolean);
  if(note) note.textContent = top3.length ? `Ranking by readiness: ${top3.join(' ‚Üí ')}` : '';
  const filtered = filter ? ranked.filter(ex=> ex.name.toLowerCase().includes(filter)) : ranked;
  filtered.forEach(ex=>{
    const opt=document.createElement('option'); opt.value=ex.id;
    const exIdxs = ex.impacts.map(i=> order.indexOf(i.mid)).filter(i=>i>=0);
    const bestIdx=Math.min.apply(null, exIdxs.length? exIdxs : [9999]);
    let tag='';
    if(bestIdx!==9999){
      const bestMid=order[bestIdx];
      const bestMuscle=state.muscles.find(m=>m.id===bestMid)?.name||'';
      tag=` ‚Ä¢ targets ${bestMuscle}`;
    }
    opt.text = ex.name + tag;
    sel.appendChild(opt);
  });
  if(!filtered.length){
    const opt=document.createElement('option'); opt.value=''; opt.text='No matches'; sel.appendChild(opt);
  }

  /* Long‚Äëpress on the dropdown to open YouTube for selected exercise */
  // Remove any previous handlers by replacing the element (cheap + safe)
  const parent = sel.parentElement;
  const clone = sel.cloneNode(true);
  parent.replaceChild(clone, sel);
  attachLongPress(clone, ()=>{
    const id = clone.value || '';
    const ex = state.exercises.find(e=>e.id===id);
    if(!ex){ showErr('Pick an exercise first.'); return; }
    openYTSearch('correct form of '+ex.name);
  });
}

function renderHistory(){
  const list=$('#history'); if(!list) return; list.innerHTML='';
  if(state.logs.length===0){
    list.appendChild(el('div',{class:'card'},['No history yet.']));
    return;
  }
  state.logs.slice(0,30).forEach(l=>{
    list.appendChild(el('div',{class:'card'},[el('div',{text:l.txt})]));
  });
}

function renderMuscles(){
  const list=$('#mList'); if(!list) return; list.innerHTML='';
  for(const m of state.muscles){
    const iconBox=el('span',{class:'micon'},[ iconImgByName(m.name) ]);
    list.appendChild(el('div',{class:'item'},[
      iconBox,
      el('div',{},[ el('div',{text:m.name}), el('small',{class:'muted',text:`Cooldown ${m.cooldown}h`}) ]),
      el('div',{},[
        el('button',{class:'btn small','data-m-act':'edit','data-id':m.id,type:'button'},['Edit']),
        el('button',{class:'btn small ghost',style:'margin-left:6px','data-m-act':'del','data-id':m.id,type:'button'},['Delete'])
      ])
    ]));
  }
}

/* ---- Muscles form actions ---- */
document.getElementById('muscles')?.addEventListener('click',(e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const act=b.getAttribute('data-m-act'); const id=b.getAttribute('data-id'); if(!act||!id) return;
  if(act==='edit'){
    const m=state.muscles.find(x=>x.id===id); if(!m) return;
    $('#mId').value=m.id; $('#mName').value=m.name; $('#mCd').value=m.cooldown; $('#mYw').value=(m.yellow??'');
    $('#mName').focus();
  }
  if(act==='del'){
    if(!confirm('Delete muscle?')) return;
    state.muscles=state.muscles.filter(x=>x.id!==id);
    state.exercises=state.exercises.map(ex=>({...ex, impacts: ex.impacts.filter(i=>i.mid!==id)}));
    save(); renderMuscles(); renderTrain(); renderExercises();
  }
});
$('#mCancel')?.addEventListener('click',()=>{ $('#mForm').reset(); $('#mId').value=''; });
$('#mSave')?.addEventListener('click',()=>{
  const id=$('#mId').value||uid();
  const name=$('#mName').value.trim();
  const cd=Number($('#mCd').value||0);
  const ywRaw=$('#mYw').value; const yw=ywRaw===''?null:Number(ywRaw);
  if(!name||cd<=0) return alert('Name and cooldown > 0');
  const existing=state.muscles.find(x=>x.id===id);
  const payload= existing? {...existing,name,cooldown:cd,yellow:yw} : {id,name,cooldown:cd,yellow:yw,lastAt:null,lastWorkedAt:null};
  state.muscles = existing? state.muscles.map(x=>x.id===id?payload:x) : [...state.muscles,payload];
  save(); $('#mForm').reset(); $('#mId').value=''; renderMuscles(); renderTrain(); renderExercises();
});

/* ---- Exercises list/forms ---- */
function renderExercises(){
  const box=$('#eMuscles'); if(!box) return; box.innerHTML='';
  for(const m of state.muscles){
    const row=el('div',{class:'pillrow'},[
      el('label',{text:m.name}),
      el('input',{type:'number',step:'1',min:'0',placeholder:'hours','data-mid':m.id})
    ]);
    box.appendChild(row);
  }
  const list=$('#eList'); if(!list) return; list.innerHTML='';
  for(const ex of state.exercises){
    const desc=ex.impacts.length? ex.impacts.map(i=>{
      const nm=state.muscles.find(m=>m.id===i.mid)?.name||'???';
      return `${nm}: +${i.hours}h`;
    }).join(', ') : '‚Äî';
    const overr=ex.override||'inherit';
    const overrLabel=overr==='inherit'?'Inherit global':(overr==='reset'?'Override: Reset':'Override: Adjust');
    list.appendChild(el('div',{class:'item'},[
      el('div',{},[ el('div',{text:ex.name}), el('small',{class:'muted',text:`${overrLabel} ‚Ä¢ ${desc}`}) ]),
      el('div',{},[
        el('button',{class:'btn small','data-e-act':'edit','data-id':ex.id,type:'button'},['Edit']),
        el('button',{class:'btn small ghost',style:'margin-left:6px','data-e-act':'del','data-id':ex.id,type:'button'},['Delete'])
      ])
    ]));
  }
}
document.getElementById('exercises')?.addEventListener('click',(e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const act=b.getAttribute('data-e-act'); const id=b.getAttribute('data-id'); if(!act||!id) return;
  if(act==='edit'){
    const ex=state.exercises.find(x=>x.id===id); if(!ex) return;
    $('#eId').value=ex.id; $('#eName').value=ex.name; $('#eOverride').value=ex.override||'inherit';
    const map=new Map(ex.impacts.map(i=>[i.mid,i.hours]));
    $$('#eMuscles input[type=number]').forEach(inp=>{
      const mid=inp.getAttribute('data-mid'); inp.value= map.has(mid)?map.get(mid):'';
    });
    $('#eName').focus();
  }
  if(act==='del'){
    if(!confirm('Delete exercise?')) return;
    state.exercises=state.exercises.filter(x=>x.id!==id);
    save(); renderExercises(); renderTrain();
  }
});
$('#eCancel')?.addEventListener('click',()=>{
  $('#eForm').reset(); $('#eId').value=''; $$('#eMuscles input[type=number]').forEach(inp=>inp.value=''); $('#eOverride').value='inherit';
});
$('#eSave')?.addEventListener('click',()=>{
  const id=$('#eId').value||uid();
  const name=$('#eName').value.trim();
  const override=$('#eOverride').value||'inherit';
  if(!name) return alert('Exercise name required');
  const impacts=$$('#eMuscles input[type=number]').map(inp=>({mid:inp.getAttribute('data-mid'),hours:Number(inp.value||0)})).filter(x=>x.hours>0);
  const existing=state.exercises.find(x=>x.id===id);
  const payload= existing? {...existing,name,override,impacts} : {id, name, override, impacts};
  state.exercises = existing? state.exercises.map(x=>x.id===id?payload:x) : [payload, ...state.exercises];
  save(); renderExercises(); renderTrain();
});

/* ---- Logger ("Mark Done") behavior ---- */
function logExerciseById(exId){
  const ex = state.exercises.find(e=>e.id===exId);
  if(!ex){ alert('Select an exercise first'); return false; }
  // Determine mode
  const mode = ex.override && ex.override!=='inherit' ? ex.override : (state.settings.globalExerciseMode || 'adjust');
  const nowIso = new Date().toISOString();
  // Update impacted muscles
  for(const i of ex.impacts){
    const m = state.muscles.find(mm=>mm.id===i.mid);
    if(!m) continue;
    if(mode==='reset'){
      m.lastAt = nowIso; // full cooldown from now
    }else{ // adjust
      const current = Math.max(0, remMs(m));
      const added = h2ms(i.hours||0);
      const newRemaining = current + added;
      setRemainingMs(m, newRemaining);
    }
    m.lastWorkedAt = nowIso;
  }
  // Add history line
  const stamp = new Date();
  const stampTxt = stamp.toLocaleString();
  state.logs.unshift({ ts: stamp.getTime(), txt: `${stampTxt} ‚Äî ${ex.name}` });
  save();
  renderAll();
  return true;
}
$('#logNowBtn')?.addEventListener('click',()=>{
  const exId = $('#logExerciseNow')?.value || '';
  logExerciseById(exId);
});

/* ---- Primary exercise modal ---- */
(function(){
  const modal = $('#ex-modal');
  modal.addEventListener('click', (e)=>{ if(e.target.closest('[data-close]')) modal.classList.remove('show'); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') modal.classList.remove('show'); });

  function openModal(title, subtitle, rows){
    $('#ex-title').textContent = title;
    $('#ex-sub').textContent = subtitle || '';
    const list = $('#ex-list'); list.innerHTML=''; rows.forEach(r=>list.appendChild(r));
    modal.classList.add('show');
  }

  function muscleByName(name){ return (state?.muscles||[]).find(m => (m.name||'').trim() === (name||'').trim()) || null; }
  function isPrimaryFor(ex, muscleId){
    const arr = ex.impacts || [];
    if (!arr.length) return false;
    const max = Math.max(...arr.map(i => Number(i.hours||0)));
    return max > 0 && arr.some(i => i.mid === muscleId && Number(i.hours||0) === max);
  }
  function primaryExercisesFor(muscleName){
    const m = muscleByName(muscleName); if (!m) return [];
    return (state?.exercises||[]).filter(ex => isPrimaryFor(ex, m.id));
  }
  function rowForExercise(ex){
    const impacts = (ex.impacts||[])
      .map(i => ({ name: (state.muscles.find(m=>m.id===i.mid)?.name)||'???', h: Number(i.hours||0) }))
      .sort((a,b)=>b.h-a.h).slice(0,3)
      .map(x => `${x.name}: +${x.h}h`).join(', ');
    const row = document.createElement('div'); row.className='row'; row.setAttribute('title','Long‚Äëpress for form video');
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:600">${ex.name}</div><div class="muted">${impacts||'‚Äî'}</div>`;
    const right = document.createElement('div');
    const btn = document.createElement('button'); btn.className='btn'; btn.type='button'; btn.textContent='Mark Done';
    btn.addEventListener('click', ()=>{
      if (logExerciseById(ex.id)) modal.classList.remove('show');
    });
    right.appendChild(btn);
    row.appendChild(left); row.appendChild(right);

    // Long‚Äëpress opens YouTube search for that exercise
    attachLongPress(row, ()=> openYTSearch('correct form of '+ex.name));

    return row;
  }

  // Click on a readiness card (ignore Clear)
  document.addEventListener('click', (e)=>{
    if (e.target.closest('button[data-action="clear"]')) return;
    const card = e.target.closest('#cards .card'); if (!card) return;
    const h3 = card.querySelector('h3'); if (!h3) return;
    const name = (h3.textContent||'').trim(); if (!name) return;
    const list = primaryExercisesFor(name);
    const rows = list.map(rowForExercise);
    const subtitle = list.length
      ? `Primary exercises for ${name} (${list.length})`
      : `No primary exercises found for ${name}.`;
    openModal('Exercises', subtitle, rows);
  }, {capture:true});
})();

/* ---- Data render & initial render ---- */
function renderData(){ /* settings UI removed with Data tab */ }
function renderAll(){ try{ renderTrain(); renderMuscles(); renderExercises(); renderHistory(); renderData(); } catch(err){ showErr(err.message||String(err)); } }
renderAll();

/* ---- Filter input live updates ---- */
$('#exerciseFilter')?.addEventListener('input', ()=> makeExerciseOptions());
</script>
  <script>
/* Muscles tab: hide form until "Add new" or Edit */
(function(){
  const panel = document.getElementById('muscles');
  const form  = document.getElementById('mForm');
  if (!panel || !form) return;

  // 1) Hide the form initially
  form.style.display = 'none';

  // 2) Add "Add new" button above the form
  const bar = document.createElement('div');
  bar.className = 'controls';
  const addBtn = document.createElement('button');
  addBtn.id = 'mAddNew';
  addBtn.type = 'button';
  addBtn.className = 'btn';
  addBtn.textContent = 'Add new';
  bar.appendChild(addBtn);
  panel.insertBefore(bar, form);

  function showFormBlank(){
    form.reset();
    document.getElementById('mId').value = '';
    form.style.display = '';
    addBtn.style.display = 'none';
    document.getElementById('mName').focus();
  }
  function showFormEdit(){
    form.style.display = '';
    addBtn.style.display = 'none';
    document.getElementById('mName').focus();
  }
  function hideForm(){
    form.style.display = 'none';
    addBtn.style.display = '';
  }

  // Open a blank form when clicking "Add new"
  addBtn.addEventListener('click', showFormBlank);

  // 3) Tie into existing buttons:
  // - Edit on a muscle shows the form (pre-filled by your existing code)
  // - Cancel hides the form
  // - Save hides the form after saving
  panel.addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if (!b) return;

    if (b.dataset && b.dataset.mAct === 'edit') {
      showFormEdit();
      return;
    }
    if (b.id === 'mCancel') {
      hideForm();
      return;
    }
    if (b.id === 'mSave') {
      // let your existing save handler run, then hide
      setTimeout(hideForm, 0);
      return;
    }
  });
})();
</script>
<script>
/* Exercises tab: hide form until "Add new" or Edit */
(function(){
  const panel = document.getElementById('exercises');
  const form  = document.getElementById('eForm');
  if (!panel || !form) return;

  // 1) Hide the form initially
  form.style.display = 'none';

  // 2) Add "Add new" button above the form
  const bar = document.createElement('div');
  bar.className = 'controls';
  const addBtn = document.createElement('button');
  addBtn.id = 'eAddNew';
  addBtn.type = 'button';
  addBtn.className = 'btn';
  addBtn.textContent = 'Add new';
  bar.appendChild(addBtn);
  panel.insertBefore(bar, form);

  function showFormBlank(){
    // Blank form
    form.reset();
    document.getElementById('eId').value = '';
    document.getElementById('eOverride').value = 'inherit';
    // clear all impact inputs
    document.querySelectorAll('#eMuscles input[type=number]').forEach(inp => inp.value = '');
    form.style.display = '';
    addBtn.style.display = 'none';
    document.getElementById('eName').focus();
  }
  function showFormEdit(){
    // Values are populated by your existing edit handler
    form.style.display = '';
    addBtn.style.display = 'none';
    document.getElementById('eName').focus();
  }
  function hideForm(){
    form.style.display = 'none';
    addBtn.style.display = '';
  }

  // Open a blank form when clicking "Add new"
  addBtn.addEventListener('click', showFormBlank);

  // 3) Hook into existing buttons inside the Exercises panel
  panel.addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if (!b) return;

    // Your existing edit buttons have data-e-act="edit"
    if (b.dataset && b.dataset.eAct === 'edit') {
      showFormEdit();
      return;
    }
    if (b.id === 'eCancel') {
      hideForm();
      return;
    }
    if (b.id === 'eSave') {
      // Let your existing save handler run, then hide
      setTimeout(hideForm, 0);
      return;
    }
  });
})();
</script>

</body>
</html>
