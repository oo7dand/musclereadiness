<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1120">
<title>Muscle Cooldown (v7.2 PWA)</title>
<style>
:root{
  --bg:#0b1120; --card:#0e1628; --text:#e8ecf3; --muted:#9aa6b2;
  --border:#1c2740; --red:#ef4444; --yellow:#f59e0b; --green:#10b981; --stale:#064e3b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
header,footer{padding:12px 16px;background:#0a1020;border-bottom:1px solid var(--border)}
footer{border-top:1px solid var(--border);border-bottom:none;text-align:center}
main{max-width:1100px;margin:0 auto;padding:16px}
h1{margin:0;font-size:20px;font-weight:600}
h2{margin:.2rem 0 .6rem;font-size:18px}
h3{margin:.15rem 0 .35rem;font-size:16px}
nav{display:flex;gap:8px;padding:8px 16px;background:#0a1020;position:sticky;top:48px;z-index:5}
.tab{background:#0f182e;color:#var(--muted);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;transition:transform .06s ease}
.tab:hover{transform:translateY(-1px)}
.tab.active{color:#fff;border-color:#334155;background:#111c32}
.panel{display:none;padding-top:10px}
.panel.active{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 0 0 1px rgba(0,0,0,.05) inset;transition:transform .06s ease, box-shadow .1s ease}
.card:hover{transform:translateY(-1px); box-shadow:0 4px 20px rgba(0,0,0,.2)}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px}
.red{background:var(--red);color:#fff}.yellow{background:#f2c14e;color:#1b1b1b}.green{background:var(--green);color:#0b2b1f}.stale{background:var(--stale);color:#e8fff6}
.dot{font-size:14px;line-height:1}
.btn{border:1px solid #2a3a55;background:#182840;color:#e5e7eb;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px;transition:transform .06s ease}
.btn:hover{transform:translateY(-1px)}
.btn.ghost{background:transparent;border-color:var(--border)}
.btn.small{padding:8px 10px;font-size:13px;border-radius:9px}
.btn.lg{padding:12px 14px;font-size:16px;border-radius:12px}
.btn[disabled]{opacity:.45;cursor:not-allowed;transform:none}
.row{display:grid;grid-template-columns:260px 1fr;gap:10px;align-items:center;margin-bottom:10px}
input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
select{appearance:none}
.list{display:flex;flex-direction:column;gap:8px}
.item{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
.micon{width:28px;height:28px;flex:0 0 28px;border-radius:6px;background:#0f1a2e;display:inline-flex;align-items:center;justify-content:center;overflow:hidden}
.micon img{width:24px;height:24px;display:block}
.pillbox{display:flex;flex-direction:column;gap:6px}
.pillrow{display:grid;grid-template-columns:1fr 140px;gap:8px;align-items:center}
small.muted{color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
hr.sep{border:0;border-top:1px solid var(--border);margin:12px 0}
.meta{display:flex;gap:8px;align-items:center;margin-top:6px}
.meta small{color:var(--muted)}
.slim{display:flex;gap:8px;align-items:center;justify-content:space-between}
.slim .title{display:flex;gap:8px;align-items:center}
.subtle{color:var(--muted);font-size:12px}
#logger{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#0c1730;border:1px solid var(--border);padding:10px;border-radius:12px}
#history .card{padding:8px}
.note{color:var(--muted);font-size:12px;margin-left:8px}
@media (max-width:560px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<header><h1>Muscle Cooldown</h1></header>
<nav>
  <button class="tab active" data-tab="train" type="button">Train</button>
  <button class="tab" data-tab="muscles" type="button">Muscles</button>
  <button class="tab" data-tab="exercises" type="button">Exercises</button>
  <button class="tab" data-tab="data" type="button">Data</button>
</nav>

<main>
  <section id="train" class="panel active">
    <div class="card" style="margin-bottom:10px">
      <div class="slim">
        <div>
          <h2 style="margin:0">Log workout</h2>
          <div class="subtle">Start typing to filter; list is ranked by your readiness order.</div>
        </div>
        <div id="logger">
          <input id="exerciseFilter" placeholder="Filter exercises…" aria-label="Filter exercises">
          <select id="logExerciseNow"></select>
          <button class="btn" id="logNowBtn" type="button">Mark Done</button>
        </div>
      </div>
      <div class="note" id="rankNote"></div>
    </div>

    <div class="slim"><h2 style="margin:0">Readiness</h2><div class="subtle">Tap Clear to force ready</div></div>
    <div id="cards" class="grid"></div>

    <hr class="sep">
    <h3>History</h3>
    <div id="history" class="list"></div>
  </section>

  <section id="muscles" class="panel">
    <h2>Muscles</h2>
    <form id="mForm" class="card" onsubmit="return false;">
      <input type="hidden" id="mId">
      <div class="row"><label>Name</label><input id="mName" placeholder="e.g., Quads"></div>
      <div class="row"><label>Cooldown (hrs)</label><input id="mCd" type="number" min="1" value="48"></div>
      <div class="row"><label>Yellow window (hrs, optional)</label><input id="mYw" type="number" min="0" placeholder="Uses default if empty"></div>
      <div class="controls">
        <button class="btn" id="mSave" type="button">Save</button>
        <button class="btn ghost" id="mCancel" type="button">Cancel</button>
      </div>
    </form>
    <div id="mList" class="list" style="margin-top:10px"></div>
  </section>

  <section id="exercises" class="panel">
    <h2>Exercises</h2>
    <form id="eForm" class="card" onsubmit="return false;">
      <input type="hidden" id="eId">
      <div class="row"><label>Name</label><input id="eName" placeholder="e.g., Barbell back squat"></div>
      <div class="row"><label>Behavior</label>
        <select id="eOverride">
          <option value="inherit">Inherit global logging</option>
          <option value="adjust">Override: Adjust impacted muscles (add hours)</option>
          <option value="reset">Override: Reset impacted muscles</option>
        </select>
      </div>
      <div class="row"><label>Impacts (hours each)</label>
        <div id="eMuscles" class="pillbox"></div>
      </div>
      <div class="controls">
        <button class="btn" id="eSave" type="button">Save</button>
        <button class="btn ghost" id="eCancel" type="button">Cancel</button>
      </div>
    </form>
    <div id="eList" class="list" style="margin-top:10px"></div>
  </section>

  <section id="data" class="panel">
    <h2>Settings & Data</h2>
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <label>Default yellow window (hrs)</label>
        <input id="setYellowDefault" type="number" min="0" value="20">
      </div>
      <div class="row">
        <label>Stale threshold (days)</label>
        <input id="setStaleDays" type="number" min="1" value="10">
      </div>
      <div class="row">
        <label>Global exercise logging</label>
        <select id="globalExerciseMode">
          <option value="adjust">Adjust remaining by impacts (add hours)</option>
          <option value="reset">Reset impacted muscles to 'just trained'</option>
        </select>
      </div>
      <button class="btn" id="saveQuick" type="button">Save Settings</button>
    </div>

    <div class="controls">
      <button class="btn" id="exportBtn" type="button">Export JSON</button>
      <label class="btn ghost">Import JSON <input id="importFile" type="file" accept="application/json" hidden></label>
      <button class="btn" id="wipeBtn" type="button">Wipe</button>
    </div>
    <div class="subtle" style="margin-top:6px">Installable PWA. Offline. Saves to this device only.</div>
  </section>
</main>

<div id="error"></div>
<footer><small>v7.2 PWA — icons added to Train & Muscles.</small></footer>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
function showErr(msg){ const e=document.getElementById("error"); e.textContent=msg; e.style.display="block"; setTimeout(()=>{ e.style.display="none"; }, 4000); }
function clone(o){ try{return JSON.parse(JSON.stringify(o))}catch{return null} }
const KEY="mct:v7_0"; const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function el(t,a={},c=[]){ const e=document.createElement(t); for(const[k,v] of Object.entries(a)){ if(k==="class")e.className=v; else if(k==="text")e.textContent=v; else if(k.startsWith("on")) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } for(const x of c) e.appendChild(typeof x==="string"?document.createTextNode(x):x); return e; }
const h2ms=h=>Number(h||0)*3600000;
function msToDh(ms){ if(ms<=0) return "0h"; const d=Math.floor(ms/86400000); const h=Math.ceil((ms%86400000)/3600000); return (d?d+"d ":"")+h+"h"; }
function agoFromIso(iso){ if(!iso) return "never"; const diff=Date.now()-new Date(iso).getTime(); const txt=msToDh(diff); return (txt==="0h"?"<1h":txt)+" ago"; }
function remMs(m){ if(!m.lastAt) return 0; return (new Date(m.lastAt).getTime()+Number(m.cooldown||0)*3600000)-Date.now(); }
function staleCheck(m){ const ref=m.lastWorkedAt??m.lastAt; if(!ref) return true; const days=(state.settings.staleDays??10); return (Date.now()-new Date(ref).getTime()) >= days*86400000; }
function colorFor(m){ const remaining=remMs(m); if(remaining>0){ const yh=(m.yellow??state.settings.yellowDefault); if(remaining<=h2ms(yh)) return "yellow"; return "red"; } else { if(staleCheck(m)) return "stale"; return "green"; } }
function setRemainingMs(m,ms){ const cd=h2ms(m.cooldown); const lastPrime=Date.now()+ms-cd; m.lastAt=new Date(lastPrime).toISOString(); }
const iconFor=st=> st==="red"?"🔴":st==="yellow"?"🟡":st==="green"?"🟢":"🟩";
const MUSCLE_SLUG = {"Quads":"quads","Hamstrings":"hamstrings","Glutes":"glutes","Lats":"lats","Chest / Pecs":"chest","Shoulders / Delts":"shoulders","Traps":"traps","Lower back":"lowerback","Upper back":"upperback","Biceps":"biceps","Triceps":"triceps","Abs":"abs","Obliques":"obliques","Calves":"calves","Forearms":"forearms"};
function iconUrl(name, size=128){ const slug = MUSCLE_SLUG[name] || name.toLowerCase().replace(/\s+/g,'-'); return `./img/muscles/${slug}-${size}.png`; }
function iconImg(name, size=128){ const img=new Image(); img.className='micon-img'; img.width=24; img.height=24; img.loading='lazy'; img.decoding='async'; img.alt=name; img.src=iconUrl(name, 128); return img; }

function buildSpec(){
  const MUSCLES = [["Quads",48],["Hamstrings",48],["Glutes",48],["Lats",36],["Chest / Pecs",36],["Shoulders / Delts",36],["Traps",36],["Lower back",36],["Biceps",24],["Triceps",24],["Abs",24],["Obliques",24],["Calves",24],["Upper back",24],["Forearms",24]];
  const mObjs = MUSCLES.map(([name,cd])=>({id:uid(), name, cooldown:cd, yellow:null, lastAt:null, lastWorkedAt:null}));
  const idBy = Object.fromEntries(mObjs.map(m=>[m.name,m.id]));
  const EX = [["Barbell back squat",[["Quads",48],["Glutes",24],["Hamstrings",24],["Lower back",36],["Abs",12]]],["Leg press",[["Quads",36],["Glutes",24],["Hamstrings",24]]],["Bulgarian split squat",[["Quads",36],["Glutes",24],["Hamstrings",24],["Abs",12]]],["Conventional deadlift",[["Hamstrings",48],["Glutes",24],["Lower back",36],["Traps",36],["Forearms",24],["Abs",12]]],["Romanian deadlift",[["Hamstrings",36],["Glutes",24],["Lower back",36]]],["Leg curl",[["Hamstrings",24],["Calves",12]]],["Barbell hip thrust",[["Glutes",36],["Hamstrings",24],["Quads",24]]],["Pull-up",[["Lats",36],["Biceps",12],["Upper back",24],["Abs",12]]],["Barbell row",[["Lats",36],["Upper back",24],["Shoulders / Delts",12],["Biceps",12],["Lower back",24],["Abs",12],["Forearms",24]]],["Landmine 1-hand row",[["Lats",36],["Biceps",12],["Upper back",24],["Abs",12]]],["Bench press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],["Incline bench press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],["Dumbbell press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],["Seated military press",[["Shoulders / Delts",36],["Traps",36],["Triceps",12],["Chest / Pecs",24]]],["Lateral raise (DB)",[["Shoulders / Delts",24],["Traps",12]]],["Rear delt fly (DB/machine)",[["Shoulders / Delts",24],["Upper back",12],["Traps",12]]],["Barbell shrug",[["Traps",36],["Forearms",24]]],["Upright row",[["Shoulders / Delts",36],["Traps",24],["Biceps",12]]],["Back extension",[["Lower back",36],["Glutes",24],["Hamstrings",24]]],["Good mornings",[["Hamstrings",36],["Lower back",36],["Glutes",24]]],["1-hand preacher curl",[["Biceps",24],["Forearms",24]]],["2-hand preacher curl",[["Biceps",24],["Forearms",24]]],["Hammer curl",[["Biceps",24],["Forearms",24]]],["Landmine triceps press",[["Triceps",24],["Shoulders / Delts",12],["Chest / Pecs",24]]],["Skull crushers",[["Triceps",24],["Forearms",24]]],["Overhead triceps extension",[["Triceps",24],["Shoulders / Delts",12]]],["Hanging leg raise",[["Abs",24],["Obliques",12]]],["Plank",[["Abs",24],["Lower back",24],["Obliques",12],["Shoulders / Delts",12]]],["Russian twist",[["Obliques",24],["Abs",12],["Lower back",24]]],["Side plank",[["Obliques",24],["Abs",12],["Shoulders / Delts",12]]],["Standing calf raise",[["Calves",24]]],["Seated calf raise",[["Calves",24]]],["Face pull (band alt)",[["Shoulders / Delts",24],["Upper back",12],["Traps",12]]],["Reverse fly (DB)",[["Shoulders / Delts",24],["Traps",12],["Upper back",12]]]];
  const eObjs = EX.map(([name, arr])=>({id:uid(), name, override:"adjust", impacts: arr.map(([n,h])=>({mid:idBy[n], hours:h})).filter(x=>x.mid)}));
  return { settings:{yellowDefault:20, staleDays:10, globalExerciseMode:"adjust"}, muscles:mObjs, exercises:eObjs, logs:[] };
}
function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return buildSpec(); const obj=JSON.parse(raw); if(!obj||!obj.muscles||!obj.exercises) return buildSpec(); obj.muscles.forEach(m=>{ if(m.lastWorkedAt===undefined) m.lastWorkedAt=m.lastAt??null; }); obj.exercises.forEach(e=>{ if('mode' in e) delete e.mode; }); return obj; }catch(e){ return buildSpec(); } }
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); } catch(e){ showErr("Save failed: "+e.message); } }
let state=load();
$$('.tab').forEach(b=>b.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  $$('.panel').forEach(p=>p.classList.remove('active'));
  b.classList.add('active'); const t=document.getElementById(b.dataset.tab); if(t) t.classList.add('active'); renderAll();
}));
function readinessOrder(){ const items = state.muscles.map(m=>{ const r=remMs(m); const stale=colorFor(m)==='stale'; return {m,r,stale}; }).sort((a,b)=>{ if(a.stale && !b.stale) return -1; if(!a.stale && b.stale) return 1; if(a.r<=0 && b.r>0) return -1; if(a.r>0 && b.r<=0) return 1; if(a.r!==b.r) return a.r-b.r; return 0; }); return items.map(x=>x.m.id); }
function renderTrain(){ makeExerciseOptions(); const grid=document.getElementById('cards'); if(!grid) return; grid.innerHTML=''; const order=readinessOrder(); const items=order.map(id=>{ const m=state.muscles.find(x=>x.id===id); return {m,remaining:remMs(m)}; }); for(const {m,remaining} of items){ const st=colorFor(m); const badge=el('span',{class:'badge '+st},[ el('span',{class:'dot',text:iconFor(st)}), el('span',{text: remaining>0? msToDh(remaining):'Ready'}) ]); const clrDisabled=remaining<=0; const iconBox=el('span',{class:'micon'},[ (function(){const i=new Image(); i.width=24;i.height=24;i.loading='lazy';i.decoding='async';i.alt=m.name;i.src= `./img/muscles/${(m.name==='Chest / Pecs'?'chest':m.name.toLowerCase().replace(/\s+\/\s+/, ' ').replace(/\s+/g,'-'))}-128.png`; return i;})() ]); const titleWrap=el('div',{class:'title'},[iconBox, el('h3',{text:m.name})]); const card=el('div',{class:'card'},[ el('div',{class:'slim'},[ titleWrap, el('div',{},[badge]) ]), el('div',{class:'subtle', text:'last: '+agoFromIso(m.lastWorkedAt??m.lastAt)}), el('div',{style:'margin-top:8px;display:flex;gap:8px'},[ el('button',{class:'btn small ghost','data-action':'clear','data-id':m.id,type:'button',...(clrDisabled?{'disabled':true,'aria-disabled':'true'}:{})},['Clear']) ]) ]); grid.appendChild(card);} }
function exerciseRankTuple(ex, order){ const idxs = ex.impacts.map(i=> order.indexOf(i.mid)).filter(i=>i>=0).sort((a,b)=>a-b); if(!idxs.length) return [9999, 9999, ex.name.toLowerCase()]; return [idxs[0], (idxs[1]??9999), ex.name.toLowerCase()]; }
function makeExerciseOptions(){ const note=$('#rankNote'); const filter=($('#exerciseFilter')?.value||'').trim().toLowerCase(); const sel=$('#logExerciseNow'); if(!sel) return; sel.innerHTML=''; const order=readinessOrder(); const ranked=state.exercises.map(ex=>({ex,key:exerciseRankTuple(ex,order)})).sort((a,b)=>{ for(let i=0;i<a.key.length;i++){ if(a.key[i]!==b.key[i]) return a.key[i]-b.key[i]; } return 0; }).map(x=>x.ex); const top3 = order.slice(0,3).map(id=>state.muscles.find(m=>m.id===id)?.name).filter(Boolean); if(note) note.textContent = top3.length ? `Ranking by readiness: ${top3.join(' → ')}` : ''; const filtered = filter ? ranked.filter(ex=> ex.name.toLowerCase().includes(filter)) : ranked; filtered.forEach(ex=>{ const opt=document.createElement('option'); opt.value=ex.id; const exIdxs = ex.impacts.map(i=> order.indexOf(i.mid)).filter(i=>i>=0); const bestIdx=Math.min.apply(null, exIdxs.length? exIdxs : [9999]); let tag=''; if(bestIdx!==9999){ const bestMid=order[bestIdx]; const bestMuscle=state.muscles.find(m=>m.id===bestMid)?.name||''; tag=` • targets ${bestMuscle}`; } opt.text = ex.name + tag; sel.appendChild(opt); }); if(!filtered.length){ const opt=document.createElement('option'); opt.value=''; opt.text='No matches'; sel.appendChild(opt);} }
function renderHistory(){ const list=$('#history'); if(!list) return; list.innerHTML=''; if(state.logs.length===0){ list.appendChild(el('div',{class:'card'},['No history yet.'])); return; } state.logs.slice(0,30).forEach(l=>{ list.appendChild(el('div',{class:'card'},[el('div',{text:l.txt})])); }); }
function renderMuscles(){ const list=$('#mList'); if(!list) return; list.innerHTML=''; for(const m of state.muscles){ const iconBox=el('span',{class:'micon'},[ (function(){const i=new Image(); i.width=24;i.height=24;i.loading='lazy';i.decoding='async';i.alt=m.name;i.src=`./img/muscles/${(m.name==='Chest / Pecs'?'chest':m.name.toLowerCase().replace(/\s+\/\s+/, ' ').replace(/\s+/g,'-'))}-128.png`; return i;})() ]); list.appendChild(el('div',{class:'item'},[ iconBox, el('div',{},[el('div',{text:m.name}), el('small',{class:'muted',text:`Cooldown ${m.cooldown}h`})]), el('div',{},[ el('button',{class:'btn small','data-m-act':'edit','data-id':m.id,type:'button'},['Edit']), el('button',{class:'btn small ghost',style:'margin-left:6px','data-m-act':'del','data-id':m.id,type:'button'},['Delete']) ]) ])); } }
document.getElementById('muscles')?.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; const act=b.getAttribute('data-m-act'); const id=b.getAttribute('data-id'); if(!act||!id) return; if(act==='edit'){ const m=state.muscles.find(x=>x.id===id); if(!m) return; document.getElementById('mId').value=m.id; document.getElementById('mName').value=m.name; document.getElementById('mCd').value=m.cooldown; document.getElementById('mYw').value=(m.yellow??''); document.getElementById('mName').focus(); } if(act==='del'){ if(!confirm('Delete muscle?')) return; state.muscles=state.muscles.filter(x=>x.id!==id); state.exercises=state.exercises.map(ex=>({...ex, impacts: ex.impacts.filter(i=>i.mid!==id)})); save(); renderMuscles(); renderTrain(); renderExercises(); } });
document.getElementById('mCancel')?.addEventListener('click',()=>{ document.getElementById('mForm').reset(); document.getElementById('mId').value=''; });
document.getElementById('mSave')?.addEventListener('click',()=>{ const id=document.getElementById('mId').value||uid(); const name=document.getElementById('mName').value.trim(); const cd=Number(document.getElementById('mCd').value||0); const ywRaw=document.getElementById('mYw').value; const yw=ywRaw===''?null:Number(ywRaw); if(!name||cd<=0) return alert('Name and cooldown > 0'); const existing=state.muscles.find(x=>x.id===id); const payload= existing? {...existing,name,cooldown:cd,yellow:yw} : {id,name,cooldown:cd,yellow:yw,lastAt:null,lastWorkedAt:null}; state.muscles = existing? state.muscles.map(x=>x.id===id?payload:x) : [...state.muscles,payload]; save(); document.getElementById('mForm').reset(); document.getElementById('mId').value=''; renderMuscles(); renderTrain(); renderExercises(); });
function renderExercises(){ const box=$('#eMuscles'); if(!box) return; box.innerHTML=''; for(const m of state.muscles){ const row=el('div',{class:'pillrow'},[ el('label',{text:m.name}), el('input',{type:'number',step:'1',min:'0',placeholder:'hours','data-mid':m.id}) ]); box.appendChild(row); } const list=$('#eList'); if(!list) return; list.innerHTML=''; for(const ex of state.exercises){ const desc=ex.impacts.length? ex.impacts.map(i=>{ const nm=state.muscles.find(m=>m.id===i.mid)?.name||'???'; return `${nm}: +${i.hours}h`; }).join(', ') : '—'; const overr=ex.override||'inherit'; const overrLabel=overr==='inherit'?'Inherit global':(overr==='reset'?'Override: Reset':'Override: Adjust'); list.appendChild(el('div',{class:'item'},[ el('div',{},[el('div',{text:ex.name}), el('small',{class:'muted',text:`${overrLabel} • ${desc}`})]), el('div',{},[ el('button',{class:'btn small','data-e-act':'edit','data-id':ex.id,type:'button'},['Edit']), el('button',{class:'btn small ghost',style:'margin-left:6px','data-e-act':'del','data-id':ex.id,type:'button'},['Delete']) ]) ])); } }
document.getElementById('exercises')?.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; const act=b.getAttribute('data-e-act'); const id=b.getAttribute('data-id'); if(!act||!id) return; if(act==='edit'){ const ex=state.exercises.find(x=>x.id===id); if(!ex) return; document.getElementById('eId').value=ex.id; document.getElementById('eName').value=ex.name; document.getElementById('eOverride').value=ex.override||'inherit'; const map=new Map(ex.impacts.map(i=>[i.mid,i.hours])); $$('#eMuscles input[type=number]').forEach(inp=>{ const mid=inp.getAttribute('data-mid'); inp.value= map.has(mid)?map.get(mid):''; }); document.getElementById('eName').focus(); } if(act==='del'){ if(!confirm('Delete exercise?')) return; state.exercises=state.exercises.filter(x=>x.id!==id); save(); renderExercises(); renderTrain(); } });
document.getElementById('eCancel')?.addEventListener('click',()=>{ document.getElementById('eForm').reset(); document.getElementById('eId').value=''; $$('#eMuscles input[type=number]').forEach(inp=>inp.value=''); document.getElementById('eOverride').value='inherit'; });
document.getElementById('eSave')?.addEventListener('click',()=>{ const id=document.getElementById('eId').value||uid(); const name=document.getElementById('eName').value.trim(); const override=document.getElementById('eOverride').value||'inherit'; if(!name) return alert('Exercise name required'); const impacts=$$('#eMuscles input[type=number]').map(inp=>({mid:inp.getAttribute('data-mid'),hours:Number(inp.value||0)})).filter(x=>x.hours>0); const existing=state.exercises.find(x=>x.id===id); const payload= existing? {...existing,name,override,impacts} : {id, name, override, impacts}; state.exercises = existing? state.exercises.map(x=>x.id===id?payload:x) : [payload, ...state.exercises]; save(); renderExercises(); renderTrain(); });
function renderData(){ document.getElementById('setYellowDefault').value=state.settings.yellowDefault??20; document.getElementById('setStaleDays').value=state.settings.staleDays??10; document.getElementById('globalExerciseMode').value=state.settings.globalExerciseMode||'adjust'; }
document.getElementById('saveQuick')?.addEventListener('click',()=>{ state.settings.yellowDefault=Math.max(0,Number(document.getElementById('setYellowDefault').value||0)); state.settings.staleDays=Math.max(1,Number(document.getElementById('setStaleDays').value||1)); state.settings.globalExerciseMode=document.getElementById('globalExerciseMode').value||'adjust'; save(); alert('Saved'); });
document.getElementById('exportBtn')?.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='muscle-cooldown.json'; a.click(); URL.revokeObjectURL(url); });
document.getElementById('importFile')?.addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj&&obj.settings&&obj.muscles&&obj.exercises){ state=obj; save(); renderAll(); alert('Imported'); } else alert('Invalid file'); }catch(err){ alert('Bad JSON'); } }; r.readAsText(f); });
document.getElementById('wipeBtn')?.addEventListener('click',()=>{ if(confirm('Wipe all data on this device?')){ state=buildSpec(); save(); renderAll(); } });
function renderAll(){ try{ renderTrain(); renderMuscles(); renderExercises(); renderHistory(); renderData(); } catch(err){ showErr(err.message||String(err)); } }
renderAll();
</script>

<script id="icons-loader-v7-2-5">
(function(){
  if (window.__iconsPatched) return; window.__iconsPatched = true;

  const ASSET_V = '7.2.5';
  const ROOT = './img/muscles';
  const PLACEHOLDER =
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQYV2NkYGD4DwABYQF1Q0kRngAAAABJRU5ErkJggg==";

  // Exact mapping to your filenames (lowercase, no extra words)
  const MAP = {
    "Abs":"abs",
    "Biceps":"biceps",
    "Calves":"calves",
    "Chest / Pecs":"chest",
    "Glutes":"glutes",
    "Hamstrings":"hamstrings",
    "Lats":"lats",
    "Lower back":"lowerback",
    "Obliques":"obliques",
    "Quads":"quads",
    "Shoulders / Delts":"shoulders",
    "Traps":"traps",
    "Triceps":"triceps",
    "Upper back":"upperback" // only if you add upperback-128.png
  };

  // Build an <img> for a given UI name
  function makeIcon(name){
    const slug = MAP[name];
    const img = new Image();
    img.width = 24; img.height = 24; img.alt = name; img.loading = 'lazy'; img.decoding = 'async';
    img.className = 'micon-img';
    if (!slug) { img.src = PLACEHOLDER; return img; }
    const url = `${ROOT}/${slug}-128.png?v=${ASSET_V}`;
    img.src = url;
    img.onerror = () => { img.src = PLACEHOLDER; };
    return img;
  }

  // Minimal styles (only if not already present)
  if (!document.getElementById('micon-css')) {
    const style = document.createElement('style'); style.id='micon-css';
    style.textContent = `.micon{width:28px;height:28px;flex:0 0 28px;border-radius:6px;background:#0f1a2e;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;margin-right:8px}`;
    document.head.appendChild(style);
  }

  // Remove Forearms from DOM if it still appears
  function hideForearmsDom(){
    document.querySelectorAll('*, * *').forEach(el=>{
      if (el.childElementCount === 0 && (el.textContent||'').trim() === 'Forearms') {
        const row = el.closest('.item,.card') || el.parentElement;
        if (row) row.style.display = 'none';
      }
    });
  }

  // Inject icons before known muscle names in Readiness and Muscles
  function injectIcons(){
    let n=0;

    // Readiness cards
    document.querySelectorAll('#cards .card h3').forEach(h3=>{
      const name = (h3.textContent||'').trim();
      if (!MAP[name] || name === 'Forearms') return;
      if (h3.previousElementSibling?.classList?.contains('micon')) return;
      const chip = document.createElement('span'); chip.className='micon'; chip.appendChild(makeIcon(name));
      h3.parentNode.insertBefore(chip, h3); n++;
    });

    // Muscles rows
    document.querySelectorAll('#mList .item').forEach(row=>{
      if (row.querySelector('.micon')) return;
      const nameEl = row.querySelector('h3, div, [data-name]');
      if (!nameEl) return;
      const name = (nameEl.textContent||'').trim();
      if (!MAP[name] || name === 'Forearms') return;
      const chip = document.createElement('span'); chip.className='micon'; chip.appendChild(makeIcon(name));
      nameEl.parentNode.insertBefore(chip, nameEl); n++;
    });

    hideForearmsDom();
    return n;
  }

  // One-time cleanup of saved data (removes Forearms + dangling impacts)
  (function cleanupSaved(){
    try{
      const KEY="mct:v7_0"; const raw=localStorage.getItem(KEY);
      if (!raw) return;
      const state = JSON.parse(raw);
      if (!state?.muscles) return;
      const before = state.muscles.length;
      state.muscles = state.muscles.filter(m => m.name !== 'Forearms');
      const valid = new Set(state.muscles.map(m=>m.id));
      state.exercises?.forEach(ex => ex.impacts = (ex.impacts||[]).filter(i => valid.has(i.mid)));
      if (state.muscles.length !== before) localStorage.setItem(KEY, JSON.stringify(state));
    } catch {}
  })();

  // Try on load and as DOM changes
  const run = () => injectIcons();
  document.addEventListener('DOMContentLoaded', run);
  window.addEventListener('load', () => { run(); setTimeout(run, 300); setTimeout(run, 1000); });
  new MutationObserver(run).observe(document.documentElement, {childList:true,subtree:true});
})();
</script>

  <script>
/* --------- Tabs: readable colors + remove 4th tab --------- */
(function(){
  // 1) Make inactive tabs readable (light text), active tab white
  const style = document.createElement('style');
  style.textContent = `
    .tab{ color:#cbd5e1 !important; background:#0f182e !important; }
    .tab.active{ color:#ffffff !important; background:#111c32 !important; border-color:#334155 !important; }
    .tab:focus-visible{ outline:2px solid #60a5fa; outline-offset:2px; }
  `;
  document.head.appendChild(style);

  // 2) Remove the 4th "Data" tab + its panel if present
  const dataTab = document.querySelector('nav .tab[data-tab="data"]');
  if (dataTab) dataTab.remove();
  const dataPanel = document.getElementById('data');
  if (dataPanel) dataPanel.remove();

  // 3) Ensure a visible default (activate first remaining tab if none active)
  const tabs = Array.from(document.querySelectorAll('nav .tab'));
  const panels = id => document.getElementById(id);
  if (!tabs.some(t => t.classList.contains('active')) && tabs.length){
    tabs[0].classList.add('active');
    const target = panels(tabs[0].dataset.tab);
    if (target){ target.classList.add('active'); }
  }

  // 4) Make the click handler tolerant if you removed a tab
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('nav .tab'); if (!b) return;
    const id = b.dataset.tab;
    document.querySelectorAll('nav .tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    b.classList.add('active');
    const panel = document.getElementById(id);
    if (panel) panel.classList.add('active');
  }, {capture:true});
})();
</script>

  
</body>
</html>
