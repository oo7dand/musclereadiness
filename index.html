<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Muscle Ready</title>
<meta name="theme-color" content="#0b1120">
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{
  --bg:#0b1120; --card:#0e1628; --text:#e8ecf3; --muted:#9aa6b2;
  --border:#1c2740; --red:#ef4444; --yellow:#f59e0b; --green:#10b981; --stale:#064e3b; --accent:#22c55e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:#0a1020;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
header img.logo{width:28px;height:28px;border-radius:6px}
header h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
nav{display:flex;gap:8px;padding:8px 16px;background:#0a1020;position:sticky;top:56px;z-index:9}
.tab{background:#0f182e;color:var(--muted);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.active{color:#fff;border-color:#334155;background:#111c32}
main{max-width:1100px;margin:0 auto;padding:16px}
.panel{display:none}
.panel.active{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
.slim{display:flex;align-items:center;justify-content:space-between;gap:8px}
h2{margin:.2rem 0 .6rem;font-size:18px}
h3{margin:.1rem 0 .3rem;font-size:16px}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px}
.red{background:var(--red);color:#fff}.yellow{background:#f2c14e;color:#111}.green{background:var(--green);color:#0b2b1f}.stale{background:var(--stale);color:#e8fff6}
.btn{border:1px solid #2a3a55;background:#182840;color:#e5e7eb;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px}
.btn.ghost{background:transparent;border-color:var(--border)}
.btn.small{padding:8px 10px;font-size:13px}
.row{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center;margin-bottom:10px}
input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
.subtle{color:var(--muted);font-size:12px}
hr.sep{border:0;border-top:1px solid var(--border);margin:12px 0}
#openData{display:block;width:100%;margin-top:14px;background:transparent;border:1px dashed var(--border);color:var(--muted)}
button[data-tab="data"]{display:none !important;}
</style>
</head>
<body>
<header>
  <img class="logo" src="icon-192.png" alt="Muscle Ready">
  <h1>Muscle Ready</h1>
</header>
<nav>
  <button class="tab active" data-tab="train" type="button">Train</button>
  <button class="tab" data-tab="muscles" type="button">Muscles</button>
  <button class="tab" data-tab="exercises" type="button">Exercises</button>
  <button class="tab" data-tab="data" type="button">Data</button>
</nav>
<main>
  <section id="train" class="panel active">
    <div class="card" style="margin-bottom:10px">
      <div class="slim">
        <div>
          <h2 style="margin:0">Log workout</h2>
          <div class="subtle" id="dropdownHint">Exercises sorted by what’s most ready</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="exerciseFilter" placeholder="Filter exercises…">
          <select id="logExerciseNow"></select>
          <button class="btn" id="logNowBtn" type="button">Mark Done</button>
        </div>
      </div>
    </div>
    <div class="slim"><h2 style="margin:0">Readiness</h2><div class="subtle">Tap Clear to force ready</div></div>
    <div id="cards" class="grid"></div>
    <button id="openData" class="btn ghost" type="button">Advanced settings</button>
    <hr class="sep">
    <h3>History</h3>
    <div id="history" class="list"></div>
  </section>
  <section id="muscles" class="panel">
    <h2>Muscles</h2>
    <form id="mForm" class="card" onsubmit="return false;">
      <input type="hidden" id="mId">
      <div class="row"><label>Name</label><input id="mName" placeholder="e.g., Quads"></div>
      <div class="row"><label>Cooldown (hrs)</label><input id="mCd" type="number" min="1" value="48"></div>
      <div class="row"><label>Yellow window (hrs, optional)</label><input id="mYw" type="number" min="0" placeholder="Uses default if empty"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="mSave" type="button">Save</button>
        <button class="btn ghost" id="mCancel" type="button">Cancel</button>
      </div>
    </form>
    <div id="mList" class="list" style="margin-top:10px"></div>
  </section>
  <section id="exercises" class="panel">
    <h2>Exercises</h2>
    <form id="eForm" class="card" onsubmit="return false;">
      <input type="hidden" id="eId">
      <div class="row"><label>Name</label><input id="eName" placeholder="e.g., Barbell back squat"></div>
      <div class="row"><label>Behavior</label>
        <select id="eOverride">
          <option value="inherit">Inherit global logging</option>
          <option value="adjust">Override: Adjust impacted muscles (add hours)</option>
          <option value="reset">Override: Reset impacted muscles</option>
        </select>
      </div>
      <div class="row"><label>Impacts (hours each)</label>
        <div id="eMuscles" class="pillbox"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="eSave" type="button">Save</button>
        <button class="btn ghost" id="eCancel" type="button">Cancel</button>
      </div>
    </form>
    <div id="eList" class="list" style="margin-top:10px"></div>
  </section>
  <section id="data" class="panel">
    <div class="slim" style="margin-bottom:8px">
      <h2>Advanced settings</h2>
      <button class="btn ghost" id="backToTrain" type="button">Back to Train</button>
    </div>
    <div class="card" style="margin-bottom:10px">
      <div class="row"><label>Default yellow window (hrs)</label><input id="setYellowDefault" type="number" min="0" value="20"></div>
      <div class="row"><label>Stale threshold (days)</label><input id="setStaleDays" type="number" min="1" value="10"></div>
      <div class="row"><label>Global exercise logging</label>
        <select id="globalExerciseMode">
          <option value="adjust">Adjust remaining by impacts (add hours, capped at cooldown)</option>
          <option value="reset">Reset impacted muscles to 'just trained'</option>
        </select>
      </div>
      <button class="btn" id="saveQuick" type="button">Save Settings</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="exportBtn" type="button">Export JSON</button>
      <label class="btn ghost">Import JSON <input id="importFile" type="file" accept="application/json" hidden></label>
      <button class="btn" id="wipeBtn" type="button">Wipe</button>
      <button class="btn" id="resetToSpec" type="button">Reset to spec</button>
    </div>
  </section>
</main>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

function clone(o){ try{return JSON.parse(JSON.stringify(o))}catch{return null} }
const KEY="mr:v7_3_fresh"; const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const h2ms=h=>Number(h||0)*3600000;
function msToDh(ms){ if(ms<=0) return "0h"; const d=Math.floor(ms/86400000); const h=Math.ceil((ms%86400000)/3600000); return (d?d+"d ":"")+h+"h"; }
function agoFromIso(iso){ if(!iso) return "never"; const diff=Date.now()-new Date(iso).getTime(); const txt=msToDh(diff); return (txt==="0h"?"<1h":txt)+" ago"; }
function remMs(m){ if(!m.lastAt) return 0; return (new Date(m.lastAt).getTime()+Number(m.cooldown||0)*3600000)-Date.now(); }
function staleCheck(m){ const ref=m.lastWorkedAt??m.lastAt; if(!ref) return true; const days=(state.settings.staleDays??10); return (Date.now()-new Date(ref).getTime()) >= days*86400000; }
function colorFor(m){ const remaining=remMs(m); if(remaining>0){ const yh=(m.yellow??state.settings.yellowDefault); if(remaining<=h2ms(yh)) return "yellow"; return "red"; } else { if(staleCheck(m)) return "stale"; return "green"; } }
function setRemainingMsCapped(m,ms){ const cap=h2ms(m.cooldown); const clamped=Math.min(Math.max(0,ms),cap); const lastPrime=Date.now()+clamped-cap; m.lastAt=new Date(lastPrime).toISOString(); }

function buildSpec(){
  const muscleList=[
    ["Quads",48],["Hamstrings",48],["Glutes",48],["Lats",36],["Chest / Pecs",36],["Shoulders / Delts",36],
    ["Traps",36],["Lower back",36],["Upper back",24],["Biceps",24],["Triceps",24],["Abs",24],["Obliques",24],["Calves",24],["Forearms",24]
  ].map(([name,cd])=>({id:uid(), name, cooldown:cd, yellow:null, lastAt:null, lastWorkedAt:null}));
  const idByName=Object.fromEntries(muscleList.map(m=>[m.name,m.id]));
  const ex=[
    ["Barbell back squat",[["Quads",48],["Glutes",24],["Hamstrings",24],["Lower back",36],["Abs",12]]],
    ["Leg press",[["Quads",36],["Glutes",24],["Hamstrings",24]]],
    ["Bulgarian split squat",[["Quads",36],["Glutes",24],["Hamstrings",24],["Abs",12]]],
    ["Conventional deadlift",[["Hamstrings",48],["Glutes",24],["Lower back",36],["Traps",36],["Forearms",12],["Abs",12]]],
    ["Romanian deadlift",[["Hamstrings",36],["Glutes",24],["Lower back",36]]],
    ["Leg curl",[["Hamstrings",24],["Calves",12]]],
    ["Barbell hip thrust",[["Glutes",36],["Hamstrings",24],["Quads",24]]],
    ["Pull-up",[["Lats",36],["Biceps",12],["Upper back",24],["Abs",12]]],
    ["Barbell row",[["Lats",36],["Upper back",24],["Shoulders / Delts",12],["Biceps",12],["Lower back",24],["Abs",12]]],
    ["Landmine 1-hand row",[["Lats",36],["Biceps",12],["Upper back",24],["Abs",12]]],
    ["Bench press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],
    ["Incline bench press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],
    ["Dumbbell press",[["Chest / Pecs",36],["Shoulders / Delts",24],["Triceps",12]]],
    ["Seated military press",[["Shoulders / Delts",36],["Traps",36],["Triceps",12],["Chest / Pecs",24]]],
    ["Lateral raise (DB)",[["Shoulders / Delts",24],["Traps",12]]],
    ["Rear delt fly (DB/machine)",[["Shoulders / Delts",24],["Upper back",12],["Traps",12]]],
    ["Barbell shrug",[["Traps",36],["Forearms",12]]],
    ["Upright row",[["Shoulders / Delts",36],["Traps",24],["Biceps",12]]],
    ["Back extension",[["Lower back",36],["Glutes",24],["Hamstrings",24]]],
    ["Good mornings",[["Hamstrings",36],["Lower back",36],["Glutes",24]]],
    ["1-hand preacher curl",[["Biceps",24],["Forearms",12]]],
    ["2-hand preacher curl",[["Biceps",24],["Forearms",12]]],
    ["Hammer curl",[["Biceps",24],["Forearms",12]]],
    ["Landmine triceps press",[["Triceps",24],["Shoulders / Delts",12],["Chest / Pecs",24]]],
    ["Skull crushers",[["Triceps",24],["Forearms",12]]],
    ["Overhead triceps extension",[["Triceps",24],["Shoulders / Delts",12]]],
    ["Hanging leg raise",[["Abs",24],["Abs",12],["Obliques",12]]],
    ["Plank",[["Abs",24],["Lower back",24],["Obliques",12],["Shoulders / Delts",12]]],
    ["Russian twist",[["Obliques",24],["Abs",12],["Lower back",24]]],
    ["Side plank",[["Obliques",24],["Abs",12],["Shoulders / Delts",12]]],
    ["Standing calf raise",[["Calves",24]]],
    ["Seated calf raise",[["Calves",24]]],
    ["Face pull (band alt)",[["Shoulders / Delts",24],["Upper back",12],["Traps",12]]],
    ["Reverse fly (DB)",[["Shoulders / Delts",24],["Traps",12],["Upper back",12]]]
  ].map(([name, pairs])=>({id:uid(), name, override:"adjust", impacts:pairs.map(([nm,hrs])=>({mid:idByName[nm], hours:hrs}))}));
  return {settings:{yellowDefault:20, staleDays:10, globalExerciseMode:"adjust"}, muscles:muscleList, exercises:ex, logs:[]};
}
function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return buildSpec(); const obj=JSON.parse(raw); if(!obj||!obj.muscles||!obj.exercises) return buildSpec(); obj.muscles.forEach(m=>{ if(m.lastWorkedAt===undefined) m.lastWorkedAt=m.lastAt??null; }); return obj; }catch(e){ return buildSpec(); } }
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); } catch(e){ alert("Save failed: "+e.message); } }
let state=load();

const importanceOrder=["Quads","Hamstrings","Glutes","Lats","Chest / Pecs","Shoulders / Delts","Traps","Lower back","Upper back","Biceps","Triceps","Abs","Obliques","Calves","Forearms"];
const importance = new Map(importanceOrder.map((n,i)=>[n,i]));

function el(t,a={},c=[]){ const e=document.createElement(t); for(const[k,v] of Object.entries(a)){ if(k==="class")e.className=v; else if(k==="text")e.textContent=v; else if(k.startsWith("on")) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); } for(const x of c) e.appendChild(typeof x==="string"?document.createTextNode(x):x); return e; }
function remSortKey(m){ const r=remMs(m); const isStale=(colorFor(m)==="stale"); return [r>0?0:1, isStale?0:1, r, importance.get(m.name)??999]; }
function renderReadiness(){
  const grid=document.getElementById("cards"); grid.innerHTML="";
  const items=state.muscles.map(m=>({m, key:remSortKey(m)})).sort((a,b)=> a.key[0]-b.key[0] || a.key[1]-b.key[1] || a.key[2]-b.key[2] || a.key[3]-b.key[3]);
  for(const {m} of items){
    const remaining=remMs(m);
    const st=colorFor(m);
    const badge=el("span",{class:"badge "+st},[ el("span",{text: remaining>0? msToDh(remaining):"Ready"}) ]);
    const clearDisabled = remaining<=0;
    const card=el("div",{class:"card"},[
      el("div",{class:"slim"},[ el("h3",{text:m.name}), el("div",{},[badge]) ]),
      el("div",{class:"subtle", text:"last: "+agoFromIso(m.lastWorkedAt??m.lastAt)}),
      el("div",{style:"margin-top:8px;display:flex;gap:8px"},[
        el("button",{class:"btn small ghost", 'data-action':"clear", 'data-id':m.id, type:"button", ...(clearDisabled?{'disabled':true,'aria-disabled':'true'}:{})},["Clear"])
      ])
    ]);
    grid.appendChild(card);
  }
}
document.addEventListener("click",(e)=>{
  const btn=e.target.closest("button"); if(!btn) return;
  if(btn.hasAttribute("disabled")) return;
  const act=btn.getAttribute("data-action"); const id=btn.getAttribute("data-id");
  if(act==="clear" && id){
    const m=state.muscles.find(x=>x.id===id); if(!m) return;
    setRemainingMsCapped(m,0);
    m.lastWorkedAt = new Date().toISOString();
    state.logs.unshift({id:uid(), txt:`Cleared ${m.name} to ready`});
    state.logs=state.logs.slice(0,100); save(); renderAll();
  }
});

function makeExerciseOptions(filter=""){
  const sel=document.getElementById("logExerciseNow"); const q=filter.trim().toLowerCase();
  const musclesSorted=state.muscles.slice().sort((a,b)=>{
    const A=remSortKey(a), B=remSortKey(b);
    return A[0]-B[0] || A[1]-B[1] || A[2]-B[2] || A[3]-B[3];
  });
  const rank=new Map(musclesSorted.map((m,i)=>[m.id,i]));
  function scoreExercise(ex){
    let best=9999;
    for(const imp of ex.impacts){ if(rank.has(imp.mid)) best=min(best, rank.get(imp.mid)); }
    return best;
  }
  // fix min typo; implement robustly
  function min(a,b){ return a<b?a:b; }
  const all = state.exercises.slice().sort((a,b)=> scoreExercise(a)-scoreExercise(b) || a.name.localeCompare(b.name));
  sel.innerHTML="";
  const list = q ? all.filter(e=>e.name.toLowerCase().includes(q)) : all;
  list.forEach(ex=> sel.appendChild(el("option",{value:ex.id,text:ex.name})));
  const topNames = musclesSorted.slice(0,3).map(m=>m.name).join(" · ");
  document.getElementById("dropdownHint").textContent = "Exercises sorted for: " + topNames;
}
function attachExerciseFilter(){ const inp=$("#exerciseFilter"); if(!inp) return; inp.addEventListener("input",()=> makeExerciseOptions(inp.value||"")); }

(function setupLongPress(){
  const sel = document.getElementById("logExerciseNow");
  let timer=null;
  function openYT(){
    const ex = state.exercises.find(e=>e.id===sel.value);
    if(!ex) return;
    const q = encodeURIComponent(ex.name + " proper form");
    window.open("https://www.youtube.com/results?search_query="+q, "_blank");
  }
  sel.addEventListener("mousedown", ()=>{ timer=setTimeout(openYT, 650); });
  sel.addEventListener("mouseup", ()=>{ if(timer){clearTimeout(timer); timer=null;} });
  sel.addEventListener("mouseleave", ()=>{ if(timer){clearTimeout(timer); timer=null;} });
  sel.addEventListener("touchstart", ()=>{ timer=setTimeout(openYT, 650); }, {passive:true});
  sel.addEventListener("touchend", ()=>{ if(timer){clearTimeout(timer); timer=null;} });
})();

function renderHistory(){
  const box=document.getElementById("history"); box.innerHTML="";
  if(!state.logs.length){ box.appendChild(el("div",{class:"card"},["No history yet."])); return; }
  state.logs.slice(0,30).forEach(l=> box.appendChild(el("div",{class:"card"},[el("div",{text:l.txt})])));
}

function renderMuscles(){ const list=$("#mList"); list.innerHTML=""; for(const m of state.muscles){ list.appendChild(el("div",{class:"card"},[ el("div",{class:"slim"},[ el("div",{},[el("div",{text:m.name}), el("div",{class:"subtle",text:`Cooldown ${m.cooldown}h`}) ]), el("div",{},[ el("button",{class:"btn small",'data-m-act':"edit",'data-id':m.id,type:"button"},["Edit"]), el("button",{class:"btn small ghost",style:"margin-left:6px",'data-m-act':"del",'data-id':m.id,type:"button"},["Delete"]) ]) ]) ])); } }
document.getElementById("muscles").addEventListener("click",(e)=>{
  const b=e.target.closest("button"); if(!b) return; const act=b.getAttribute("data-m-act"); const id=b.getAttribute("data-id");
  if(act==="edit"){ const m=state.muscles.find(x=>x.id===id); $("#mId").value=m.id; $("#mName").value=m.name; $("#mCd").value=m.cooldown; $("#mYw").value=(m.yellow??""); }
  if(act==="del"){ if(!confirm("Delete muscle?")) return; state.muscles=state.muscles.filter(x=>x.id!==id); state.exercises=state.exercises.map(ex=>({...ex, impacts: ex.impacts.filter(i=>i.mid!==id)})); save(); renderAll(); }
});
$("#mSave").addEventListener("click",()=>{
  const id=$("#mId").value||uid(); const name=$("#mName").value.trim(); const cd=Number($("#mCd").value||0); const ywRaw=$("#mYw").value; const yw=ywRaw===""?null:Number(ywRaw);
  if(!name||cd<=0) return alert("Name and cooldown > 0");
  const ex=state.muscles.find(x=>x.id===id);
  const payload= ex? {...ex,name,cooldown:cd,yellow:yw} : {id,name,cooldown:cd,yellow:yw,lastAt:null,lastWorkedAt:null};
  state.muscles = ex? state.muscles.map(x=>x.id===id?payload:x) : [...state.muscles,payload];
  save(); $("#mForm").reset(); $("#mId").value=""; renderAll();
});
$("#mCancel").addEventListener("click",()=>{ $("#mForm").reset(); $("#mId").value=""; });

function renderExerciseEditor(){
  const box=$("#eMuscles"); box.innerHTML=""; for(const m of state.muscles){ box.appendChild(el("div",{class:"row"},[ el("label",{text:m.name}), el("input",{type:"number",step:"1",min:"0",placeholder:"hours",'data-mid':m.id}) ])); }
}
function renderExercises(){ renderExerciseEditor(); const list=$("#eList"); list.innerHTML=""; for(const ex of state.exercises){ const desc=ex.impacts.length? ex.impacts.map(i=>{ const nm=state.muscles.find(m=>m.id===i.mid)?.name||"???"; return `${nm}: +${i.hours}h`; }).join(", ") : "—"; const overr=ex.override||"inherit"; const overrLabel=overr==="inherit"?"Inherit global":(overr==="reset"?"Override: Reset":"Override: Adjust"); list.appendChild(el("div",{class:"card"},[ el("div",{class:"slim"},[ el("div",{},[el("div",{text:ex.name}), el("div",{class:"subtle",text:`${overrLabel} • ${desc}`}) ]), el("div",{},[ el("button",{class:"btn small",'data-e-act':"edit",'data-id':ex.id,type:"button"},["Edit"]), el("button",{class:"btn small ghost",style:"margin-left:6px",'data-e-act':"del",'data-id':ex.id,type:"button"},["Delete"]) ]) ]) ])); } }
document.getElementById("exercises").addEventListener("click",(e)=>{
  const b=e.target.closest("button"); if(!b) return; const act=b.getAttribute("data-e-act"); const id=b.getAttribute("data-id");
  if(act==="edit"){ const ex=state.exercises.find(x=>x.id===id); $("#eId").value=ex.id; $("#eName").value=ex.name; $("#eOverride").value=ex.override||"inherit"; const map=new Map(ex.impacts.map(i=>[i.mid,i.hours])); $$("#eMuscles input[type=number]").forEach(inp=>{ const mid=inp.getAttribute("data-mid"); inp.value= map.has(mid)?map.get(mid):""; }); }
  if(act==="del"){ if(!confirm("Delete exercise?")) return; state.exercises=state.exercises.filter(x=>x.id!==id); save(); renderAll(); }
});
$("#eCancel").addEventListener("click",()=>{ $("#eForm").reset(); $("#eId").value=""; $$("#eMuscles input[type=number]").forEach(inp=>inp.value=""); $("#eOverride").value="inherit"; });
$("#eSave").addEventListener("click",()=>{
  const id=$("#eId").value||uid(); const name=$("#eName").value.trim(); const override=$("#eOverride").value||"inherit";
  if(!name) return alert("Exercise name required");
  const impacts=$$("#eMuscles input[type=number]").map(inp=>({mid:inp.getAttribute("data-mid"),hours:Number(inp.value||0)})).filter(x=>x.hours>0);
  const ex=state.exercises.find(x=>x.id===id); const payload= ex? {...ex,name,override,impacts} : {id,name,override,impacts};
  state.exercises= ex? state.exercises.map(x=>x.id===id?payload:x) : [...state.exercises,payload];
  save(); $("#eForm").reset(); $("#eId").value=""; $$("#eMuscles input[type=number]").forEach(inp=>inp.value=""); $("#eOverride").value="inherit"; renderAll();
});

function effectiveBehavior(ex){ const o=ex.override||"inherit"; if(o==="inherit") return state.settings.globalExerciseMode||"adjust"; if(o==="reset") return "reset"; return "adjust"; }
document.getElementById("logNowBtn").addEventListener("click",()=>{
  const id=$("#logExerciseNow").value; const ex=state.exercises.find(e=>e.id===id);
  if(!ex) return alert("Pick an exercise");
  const behavior=effectiveBehavior(ex); const nowIso=new Date().toISOString();
  if(behavior==="reset"){
    ex.impacts.forEach(imp=>{ const m=state.muscles.find(mm=>mm.id===imp.mid); if(m){ m.lastAt=nowIso; m.lastWorkedAt=nowIso; } });
  } else {
    ex.impacts.forEach(imp=>{
      const m=state.muscles.find(mm=>mm.id===imp.mid); if(!m) return;
      const delta=h2ms(imp.hours||0);
      const current=Math.max(0,remMs(m));
      setRemainingMsCapped(m, current+delta);
      m.lastWorkedAt=nowIso;
    });
  }
  state.logs.unshift({id:uid(), txt:`Done: ${ex.name}`});
  state.logs = state.logs.slice(0,100);
  save(); renderAll();
});

function switchTab(id){
  $$(".tab").forEach(b=>b.classList.remove("active"));
  $$(".panel").forEach(p=>p.classList.remove("active"));
  const btn = $$("button.tab").find(b=>b.dataset.tab===id);
  if(btn) btn.classList.add("active");
  document.getElementById(id).classList.add("active");
  if(id==="train") { makeExerciseOptions($("#exerciseFilter").value||""); }
}
$$("button.tab").forEach(b=> b.addEventListener("click", ()=> switchTab(b.dataset.tab)));
document.getElementById("openData").addEventListener("click", ()=> switchTab("data"));
document.getElementById("backToTrain").addEventListener("click", ()=> switchTab("train"));

function renderData(){ $("#setYellowDefault").value=state.settings.yellowDefault??20; $("#setStaleDays").value=state.settings.staleDays??10; $("#globalExerciseMode").value=state.settings.globalExerciseMode||"adjust"; }
$("#saveQuick").addEventListener("click",()=>{ state.settings.yellowDefault=Math.max(0,Number($("#setYellowDefault").value||0)); state.settings.staleDays=Math.max(1,Number($("#setStaleDays").value||1)); state.settings.globalExerciseMode=$("#globalExerciseMode").value||"adjust"; save(); alert("Saved"); });
$("#exportBtn").addEventListener("click",()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="muscle-ready-data.json"; a.click(); URL.revokeObjectURL(url); });
$("#importFile").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj&&obj.settings&&obj.muscles&&obj.exercises){ state=obj; save(); renderAll(); alert("Imported"); } else alert("Invalid file"); }catch(err){ alert("Bad JSON"); } }; r.readAsText(f); });
$("#wipeBtn").addEventListener("click",()=>{ if(confirm("Wipe all data on this device?")){ state=buildSpec(); save(); renderAll(); }});
$("#resetToSpec").addEventListener("click",()=>{ if(!confirm("Replace current data with spec?")) return; state=buildSpec(); save(); renderAll(); alert("Reset to spec."); });

function renderAll(){ renderReadiness(); renderMuscles(); renderExercises(); renderHistory(); renderData(); makeExerciseOptions($("#exerciseFilter")?.value||""); }
function attachExerciseFilter(){ const inp=$("#exerciseFilter"); if(!inp) return; inp.addEventListener("input",()=> makeExerciseOptions(inp.value||"")); }
attachExerciseFilter();
renderAll();
</script>
</body>
</html>
